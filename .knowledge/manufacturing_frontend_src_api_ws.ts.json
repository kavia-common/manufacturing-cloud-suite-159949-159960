{"is_source_file": true, "format": "TypeScript", "description": "This file defines a WebSocket utility and React hook for real-time KPI data streaming in a manufacturing dashboard frontend. It includes functions for constructing WebSocket URLs, establishing connections with authentication, handling messages, and normalizing snapshot data received over WebSocket.", "external_files": ["../utils/storage"], "external_methods": ["getStoredAuth"], "published": ["connectDashboardWS", "useDashboardStream"], "classes": [], "methods": [{"name": "function buildWsBase(): string { buildWsBase", "description": "Constructs the base URL for WebSocket connection, either from environment variables or current location.", "scope": "", "scopeKind": ""}, {"name": "export function connectDashboardWS(handlers: WSHandlers): WebSocket { connectDashboardWS", "description": "Establishes a WebSocket connection to the dashboard real-time KPI stream, passing authentication tokens as query parameters.", "scope": "", "scopeKind": ""}, {"name": "export function useDashboardStream(onSnapshot: any) { useDashboardStream", "description": "React hook that manages WebSocket connection with auto-reconnect and passes KPI snapshots to a callback.", "scope": "", "scopeKind": ""}, {"name": "function normalizeSnapshot(raw: any): KpiSnapshot | null { normalizeSnapshot", "description": "Converts raw WebSocket message data into a normalized KPI snapshot object.", "scope": "", "scopeKind": ""}, {"name": "function asNumber(v: any, fallback?: number) { asNumber", "description": "Utility to parse a value as a finite number, with a fallback.", "scope": "", "scopeKind": ""}], "calls": ["getStoredAuth", "JSON.parse", "new WebSocket", "globalThis.setTimeout", "ws.close", "setTimeout", "JSON.parse"], "search-terms": ["WebSocket KPI stream", "Dashboard WebSocket connection", "React useDashboardStream hook", "normalize KPI snapshot", "manufacturing frontend WebSocket"], "state": 2, "file_id": 30, "knowledge_revision": 112, "git_revision": "", "revision_history": [{"79": ""}, {"94": ""}, {"95": ""}, {"100": ""}, {"106": ""}, {"107": ""}, {"112": ""}], "ctags": [{"_type": "tag", "name": "KpiSnapshot", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^export type KpiSnapshot = {$/", "language": "TypeScript", "kind": "alias"}, {"_type": "tag", "name": "WSHandlers", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^type WSHandlers = {$/", "language": "TypeScript", "kind": "alias"}, {"_type": "tag", "name": "asNumber", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^function asNumber(v: any, fallback?: number) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "attemptRef", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const attemptRef = React.useRef(0);$/", "language": "TypeScript", "kind": "constant", "scope": "useDashboardStream", "scopeKind": "function"}, {"_type": "tag", "name": "base", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const base = buildWsBase();$/", "language": "TypeScript", "kind": "constant", "scope": "connectDashboardWS", "scopeKind": "function"}, {"_type": "tag", "name": "buildWsBase", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^function buildWsBase(): string {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "connect", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^    const connect = () => {$/", "language": "TypeScript", "kind": "constant", "scope": "useDashboardStream", "scopeKind": "function"}, {"_type": "tag", "name": "connectDashboardWS", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^export function connectDashboardWS(handlers: WSHandlers): WebSocket {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "data", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const data = raw.type && raw.data ? raw.data : raw;$/", "language": "TypeScript", "kind": "constant", "scope": "normalizeSnapshot", "scopeKind": "function"}, {"_type": "tag", "name": "loc", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const loc = globalThis.location;$/", "language": "TypeScript", "kind": "constant", "scope": "buildWsBase", "scopeKind": "function"}, {"_type": "tag", "name": "msg", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^      const msg = JSON.parse(e.data as string);$/", "language": "TypeScript", "kind": "constant", "scope": "connectDashboardWS", "scopeKind": "function"}, {"_type": "tag", "name": "n", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const n = typeof v === 'number' ? v : Number(v);$/", "language": "TypeScript", "kind": "constant", "scope": "asNumber", "scopeKind": "function"}, {"_type": "tag", "name": "normalizeSnapshot", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^function normalizeSnapshot(raw: any): KpiSnapshot | null {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "path", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const path = '\\/ws\\/dashboard';$/", "language": "TypeScript", "kind": "constant", "scope": "connectDashboardWS", "scopeKind": "function"}, {"_type": "tag", "name": "proto", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const proto = loc.protocol === 'https:' ? 'wss:' : 'ws:';$/", "language": "TypeScript", "kind": "constant", "scope": "buildWsBase", "scopeKind": "function"}, {"_type": "tag", "name": "qs", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const qs = new URLSearchParams();$/", "language": "TypeScript", "kind": "constant", "scope": "connectDashboardWS", "scopeKind": "function"}, {"_type": "tag", "name": "raw", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const data = raw.type && raw.data ? raw.data : raw;$/", "language": "TypeScript", "kind": "constant", "scope": "normalizeSnapshot", "scopeKind": "function"}, {"_type": "tag", "name": "raw", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const raw = (import.meta as any).env?.VITE_WS_BASE_URL as string | undefined;$/", "language": "TypeScript", "kind": "constant", "scope": "buildWsBase", "scopeKind": "function"}, {"_type": "tag", "name": "stored", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const stored = getStoredAuth();$/", "language": "TypeScript", "kind": "constant", "scope": "connectDashboardWS", "scopeKind": "function"}, {"_type": "tag", "name": "tenant", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const tenant = stored?.tenantId || '';$/", "language": "TypeScript", "kind": "constant", "scope": "connectDashboardWS", "scopeKind": "function"}, {"_type": "tag", "name": "token", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const token = stored?.token || '';$/", "language": "TypeScript", "kind": "constant", "scope": "connectDashboardWS", "scopeKind": "function"}, {"_type": "tag", "name": "ts", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const ts = data.ts || data.timestamp || new Date().toISOString();$/", "language": "TypeScript", "kind": "constant", "scope": "normalizeSnapshot", "scopeKind": "function"}, {"_type": "tag", "name": "useDashboardStream", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^export function useDashboardStream(onSnapshot: any) {$/", "language": "TypeScript", "kind": "function"}, {"_type": "tag", "name": "v", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const n = typeof v === 'number' ? v : Number(v);$/", "language": "TypeScript", "kind": "constant", "scope": "asNumber", "scopeKind": "function"}, {"_type": "tag", "name": "ws", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const ws = new WebSocket(`${base}${path}?${qs.toString()}`);$/", "language": "TypeScript", "kind": "constant", "scope": "connectDashboardWS", "scopeKind": "function"}, {"_type": "tag", "name": "wsRef", "path": "/home/kavia/workspace/code-generation/manufacturing-cloud-suite-159949-159960/manufacturing_frontend/src/api/ws.ts", "pattern": "/^  const wsRef = React.useRef<WebSocket | null>(null);$/", "language": "TypeScript", "kind": "constant", "scope": "useDashboardStream", "scopeKind": "function"}], "hash": "fcd84223cbf11e3e2bf7252b9f11004b", "format-version": 4, "code-base-name": "manufacturing_frontend", "filename": "manufacturing_frontend/src/api/ws.ts"}